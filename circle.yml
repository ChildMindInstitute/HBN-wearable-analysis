# Configuration file for circleci.com continuous integration (testing)

machine:

  python:
    version: 2.7.10

  environment:
    MINI: $HOME/miniconda2
    MB: $HOME/mindboggle
    vtk_cpp_tools: $MB/vtk_cpp_tools/bin
    PATH: $MINI/bin:$vtk_cpp_tools:$PATH

dependencies:

  pre:

    #-------------------------------------------------------------------------
    # Install system-wide dependencies in linux
    #-------------------------------------------------------------------------
    - sudo apt-get update; sudo apt-get install g++ git make xorg
    #-------------------------------------------------------------------------
    # Install conda and add it to PATH
    #-------------------------------------------------------------------------
    - wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
    - bash miniconda.sh -b -p $MINI
    #-------------------------------------------------------------------------
    # Update conda and print info about the installation (for debugging)
    #-------------------------------------------------------------------------
    - conda config --set always_yes yes
    - conda update -q conda
    - conda info -a
    #-------------------------------------------------------------------------
    # Use conda and pip to set up python environment:
    #-------------------------------------------------------------------------
    - conda install cmake pip numpy scipy matplotlib pandas networkx vtk ipython
    - pip install --upgrade pip
    - pip install pytest nose coverage  # install testing tools for circle
    - pip install nibabel nipype
    #-------------------------------------------------------------------------
    # Fix paths to Linux libraries using symbolic links:
    #-------------------------------------------------------------------------
    # To avoid the following errors:
    # "No rule to make target `/usr/lib/x86_64-linux-gnu/libGLU.so'"
    # ...
    # http://techtidings.blogspot.com/2012/01/problem-with-libglso-on-64-bit-ubuntu.html
    - sudo mkdir /usr/lib64
    - sudo ln -s /usr/lib/x86_64-linux-gnu/libGLU.so.1 /usr/lib64/libGLU.so
    - sudo ln -s /usr/lib/x86_64-linux-gnu/libSM.so.6 /usr/lib64/libSM.so
    - sudo ln -s /usr/lib/x86_64-linux-gnu/libICE.so.6 /usr/lib64/libICE.so
    - sudo ln -s /usr/lib/x86_64-linux-gnu/libX11.so.6 /usr/lib64/libX11.so
    - sudo ln -s /usr/lib/x86_64-linux-gnu/libXext.so.6 /usr/lib64/libXext.so
    - sudo ln -s /usr/lib/x86_64-linux-gnu/libXt.so.6 /usr/lib64/libXt.so
    - sudo ln -s /usr/lib/x86_64-linux-gnu/mesa/libGL.so.1 /usr/lib64/libGL.so
    #-------------------------------------------------------------------------
    # Install Mindboggle
    #-------------------------------------------------------------------------
    - pip install -I .
    #- git clone https://github.com/nipy/mindboggle.git $MB
    #- cd $MB && python setup.py install
    - mkdir $vtk_cpp_tools && cd $vtk_cpp_tools && cmake ../ && make
    #- export vtk_cpp_tools=$vtk_cpp_tools
    #- export PATH=$vtk_cpp_tools:$PATH
    #- export PATH=$MINI/bin:$PATH

test:

  override:

    - cd $MB && py.test